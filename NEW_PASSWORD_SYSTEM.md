# 🔐 نظام تغيير كلمة المرور الجديد
# New Password Change System

---

## ✅ تم التحديث بنجاح!

تم تحديث نظام تغيير كلمة المرور ليعمل **مباشرة من التطبيق** بدون الحاجة لإرسال روابط عبر البريد الإلكتروني.

---

## 🎯 كيف يعمل النظام الجديد

### الطريقة القديمة ❌
1. المستخدم ينسى كلمة المرور
2. يطلب إرسال رابط عبر البريد
3. **المشكلة**: الإيميل لا يصل أو يستغرق وقتاً طويلاً
4. يفتح الرابط ويغير كلمة المرور

### الطريقة الجديدة ✅
1. المستخدم يضغط "نسيت كلمة المرور؟"
2. يتم توجيهه مباشرة لصفحة تغيير كلمة المرور
3. يدخل:
   - البريد الإلكتروني
   - كلمة المرور الحالية (للتحقق من هويته)
   - كلمة المرور الجديدة
   - تأكيد كلمة المرور
4. يتم التغيير **فوراً**
5. يتم إرسال إيميل **تأكيد** فقط (ليس رابط)

---

## 📁 الملفات التي تم إنشاؤها/تعديلها

### 1. API Endpoint جديد
**الملف**: `src/pages/api/auth/change-password.ts`

**الوظيفة**:
- يتحقق من أن المستخدم مسجل دخول (من خلال session cookie)
- يتحقق من أن المستخدم admin
- يقوم بتغيير كلمة المرور في Firebase
- يعيد استجابة بالنجاح أو الفشل

**المدخلات**:
```json
{
  "email": "admin@sabstore.com",
  "oldPassword": "old123456",
  "newPassword": "new123456"
}
```

**المخرجات**:
```json
{
  "success": true,
  "message": "تم تغيير كلمة المرور بنجاح"
}
```

---

### 2. صفحة تغيير كلمة المرور
**الملف**: `src/pages/admin/reset-password.tsx`

**الميزات**:
- ✅ نموذج بسيط وواضح
- ✅ التحقق من الهوية باستخدام كلمة المرور الحالية
- ✅ التحقق من تطابق كلمة المرور الجديدة
- ✅ التحقق من قوة كلمة المرور (6 أحرف على الأقل)
- ✅ رسائل خطأ واضحة بالعربية والإنجليزية
- ✅ إرسال إيميل تأكيد بعد التغيير الناجح
- ✅ التوجيه التلقائي لصفحة تسجيل الدخول بعد 3 ثوانٍ

**حقول النموذج**:
1. البريد الإلكتروني
2. كلمة المرور الحالية
3. كلمة المرور الجديدة
4. تأكيد كلمة المرور الجديدة

---

### 3. تحديث صفحة تسجيل الدخول
**الملف**: `src/pages/admin/login.tsx`

**التغييرات**:
- إزالة النافذة المنبثقة (modal) المعقدة
- زر "نسيت كلمة المرور؟" يوجه **مباشرة** لصفحة `/admin/reset-password`
- تبسيط الكود وإزالة الوظائف غير المستخدمة

---

## 🔒 الأمان

### التحقق من الهوية
1. **في الواجهة الأمامية (Frontend)**:
   - يتم تسجيل الدخول بكلمة المرور الحالية
   - يتم إعادة المصادقة (re-authentication) للتأكد

2. **في الخادم (Backend)**:
   - التحقق من session cookie
   - التحقق من أن المستخدم admin
   - التحقق من تطابق البريد الإلكتروني

### إيميل التأكيد
بعد تغيير كلمة المرور بنجاح، يتم إرسال إيميل يحتوي على:
- ✅ تأكيد نجاح العملية
- 📧 البريد الإلكتروني المستخدم
- 🕐 التاريخ والوقت
- ⚠️ تنبيه إذا لم يكن المستخدم من قام بهذا التغيير

---

## 🧪 الاختبار

### 1. افتح صفحة تسجيل الدخول
```
http://localhost:3000/admin/login
```

### 2. اضغط "نسيت كلمة المرور؟"

### 3. في صفحة تغيير كلمة المرور
```
البريد الإلكتروني: admin@sabstore.com
كلمة المرور الحالية: [كلمة المرور القديمة]
كلمة المرور الجديدة: [كلمة المرور الجديدة]
تأكيد كلمة المرور: [كلمة المرور الجديدة]
```

### 4. اضغط "تغيير كلمة المرور"

### 5. النتيجة المتوقعة
- ✅ رسالة نجاح
- ✅ إيميل تأكيد يصل للبريد
- ✅ توجيه تلقائي لصفحة تسجيل الدخول
- ✅ يمكن تسجيل الدخول بكلمة المرور الجديدة

---

## ⚠️ رسائل الخطأ المحتملة

| الخطأ | السبب | الحل |
|-------|-------|------|
| "كلمة المرور القديمة خاطئة" | كلمة المرور الحالية غير صحيحة | تأكد من إدخال كلمة المرور الحالية الصحيحة |
| "كلمات المرور غير متطابقة" | كلمة المرور الجديدة وتأكيدها مختلفان | تأكد من كتابة نفس كلمة المرور في الحقلين |
| "كلمة المرور يجب أن تكون 6 أحرف على الأقل" | كلمة المرور قصيرة جداً | استخدم 6 أحرف على الأقل |
| "كلمة المرور الجديدة يجب أن تكون مختلفة" | نفس كلمة المرور القديمة | استخدم كلمة مرور جديدة مختلفة |
| "المستخدم غير موجود" | البريد الإلكتروني غير مسجل | تحقق من البريد الإلكتروني |
| "غير مصرح" | لست مسجل دخول | سجل دخول أولاً |

---

## 💡 المزايا

### 1. سرعة أكبر ⚡
- لا حاجة لانتظار وصول الإيميل
- التغيير يتم **فوراً**

### 2. أمان أعلى 🔒
- التحقق من الهوية باستخدام كلمة المرور الحالية
- لا روابط قد تُسرق أو تنتهي صلاحيتها

### 3. تجربة مستخدم أفضل 😊
- واجهة بسيطة وواضحة
- رسائل خطأ مفهومة
- لا تعقيدات

### 4. موثوقية أعلى ✅
- لا مشاكل مع عدم وصول الإيميلات
- يعمل دائماً بدون اعتماد على خدمة البريد

---

## 📚 ملاحظات تقنية

### Dependencies المضافة
```json
{
  "cookie": "^0.6.0",
  "@types/cookie": "^0.6.0"
}
```

### Firebase Admin SDK
يتم استخدامه لتغيير كلمة المرور:
```typescript
await adminAuth.updateUser(uid, {
  password: newPassword,
});
```

### Session Management
- يتم التحقق من session cookie في الـ API
- يتم التأكد من أن المستخدم admin قبل السماح بالتغيير

---

## 🎉 الخلاصة

**قبل**:
- ❌ إرسال رابط عبر البريد
- ❌ الإيميل قد لا يصل
- ❌ الانتظار والتعقيد
- ❌ روابط تنتهي صلاحيتها

**بعد**:
- ✅ تغيير مباشر من التطبيق
- ✅ سريع وفوري
- ✅ آمن ومحمي
- ✅ بسيط وسهل الاستخدام
- ✅ إيميل تأكيد فقط (اختياري)

---

## 📞 المساعدة

إذا واجهت أي مشكلة:
1. تحقق من console في المتصفح (F12)
2. تحقق من logs في Terminal
3. تأكد من أن Firebase Admin SDK معد بشكل صحيح
4. تأكد من أن المستخدم admin في Firebase Authentication

---

**تم بنجاح! ✨**

النظام الآن أبسط، أسرع، وأكثر موثوقية من قبل!
